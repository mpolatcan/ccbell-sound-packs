name: Theme Curation with Claude

on:
  # Manual trigger with theme input
  workflow_dispatch:
    inputs:
      theme:
        description: |
          Theme for the sound pack (e.g., retro, futuristic, nature, cinematic, lofi)
          Claude Code will search and curate sounds matching this theme.
        required: true
        type: string

  # Trigger via issue comment: "!curate retro"
  issue_comment:
    types: [created]

env:
  ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}

jobs:
  curate-pack:
    name: Curate "${{ steps.theme.outputs.value }}" Theme
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' || (github.event_name == 'issue_comment' && starts_with(github.event.comment.body, '!curate'))

    steps:
      # 1. Checkout repo
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_TOKEN }}

      # 2. Parse theme from input or comment
      - name: Parse theme
        id: theme
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            THEME="${{ github.event.inputs.theme }}"
          else
            THEME=$(echo "${{ github.event.comment.body }}" | sed 's/!curate *//' | tr -d ' ')
          fi
          echo "value=$THEME" >> $GITHUB_OUTPUT
          echo "Theme: $THEME"

      # 3. Install dependencies
      - name: Set up dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y curl jq ffmpeg

      # 4. Claude Code creates the ENTIRE pack
      - name: Claude Code Curation
        id: claude
        uses: anthropics/claude-code-action@v1
        with:
          prompt: |
            You are a sound curator for ccbell notification plugin.

            YOUR TASK:
            Create a complete sound pack for theme: "${{ steps.theme.outputs.value }}"

            STEPS:
            1. Create directory: packs/${{ steps.theme.outputs.value }}/sounds/
            2. Search Pixabay API for sounds matching the theme for each event:
               - stop: completion, done, success sounds
               - permission_prompt: subtle notification, alert sounds
               - idle_prompt: waiting, timer, pause sounds
               - subagent: agent complete, task done sounds
            3. For each event, download the best matching sound to packs/${{ steps.theme.outputs.value }}/sounds/
            4. Convert each sound to AIFF format (ffmpeg -i input.aiff -f aiff output.aiff)
            5. Create packs/${{ steps.theme.outputs.value }}/pack.json with proper structure:

            ```json
            {
              "id": "${{ steps.theme.outputs.value }}",
              "name": "Theme Name (capitalized)",
              "description": "Description of the theme",
              "author": "claude-code",
              "version": "1.0.0",
              "events": {
                "stop": "stop.aiff",
                "permission_prompt": "permission_prompt.aiff",
                "idle_prompt": "idle_prompt.aiff",
                "subagent": "subagent.aiff"
              },
              "source": "pixabay",
              "license": "pixabay"
            }
            ```

            REQUIREMENTS:
            - Use Pixabay API: https://pixabay.com/api/?q={query}&category=sound-effects&per_page=5
            - Convert all sounds to AIFF (macOS compatible)
            - Use event-specific search queries
            - Clean up any MP3/WAV files after conversion
            - Create proper pack.json with all metadata

            OUTPUT:
            - Create the complete pack structure at: packs/${{ steps.theme.outputs.value }}/
            - List what you created: ls -la packs/${{ steps.theme.outputs.value }}/
            - Show the pack.json content
            - Tell the user the pack is ready for PR

            Do NOT output a shell script. Do the work DIRECTLY in the filesystem.

      # 5. Verify pack was created
      - name: Verify pack
        id: verify
        run: |
          THEME="${{ steps.theme.outputs.value }}"
          echo "Verifying pack for theme: $THEME"

          if [ -d "packs/$THEME" ]; then
            echo "Pack directory exists"
            ls -la "packs/$THEME/"

            if [ -f "packs/$THEME/pack.json" ]; then
              echo "pack.json found:"
              cat "packs/$THEME/pack.json"
            else
              echo "ERROR: pack.json not found"
              exit 1
            fi

            sound_count=$(find "packs/$THEME/sounds" -name "*.aiff" | wc -l)
            echo "Sounds created: $sound_count"

            if [ "$sound_count" -lt 1 ]; then
              echo "ERROR: No sound files found"
              exit 1
            fi
          else
            echo "ERROR: Pack directory not created"
            exit 1
          fi

      # 6. Create Pull Request
      - name: Create Pull Request
        id: pr
        uses: peter-evans/create-pull-request@v3
        with:
          token: ${{ secrets.GH_TOKEN }}
          commit-message: "Add ${{ steps.theme.outputs.value }} themed sound pack"
          title: "Add ${{ steps.theme.outputs.value }} themed sound pack"
          body: |
            ## Summary
            Sound pack curated by Claude Code for theme: **${{ steps.theme.outputs.value }}**

            ## How It Was Curated
            1. Theme: `${{ steps.theme.outputs.value }}`
            2. Claude Code searched Pixabay for matching sounds
            3. Claude Code downloaded and converted sounds to AIFF
            4. Claude Code created pack structure with metadata

            ## Events Included
            - [ ] stop
            - [ ] permission_prompt
            - [ ] idle_prompt
            - [ ] subagent

            ## To Use
            ```bash
            /ccbell:packs install ${{ steps.theme.outputs.value }}
            /ccbell:packs use ${{ steps.theme.outputs.value }}
            ```

            ## Review Notes
            - Sounds sourced from Pixabay (Pixabay License)
            - Converted to AIFF for macOS compatibility
            - Review sounds and adjust as needed before merging
          branch: "curated/${{ steps.theme.outputs.value }}"

      # 7. Comment on issue/PR
      - name: Comment on result
        if: always()
        uses: actions/github-script@v6
        with:
          script: |
            const theme = "${{ steps.theme.outputs.value }}";
            const success = "${{ job.status }}" === "success";

            // Get PR number if created
            const prNumber = process.env.PR_NUMBER || "a new PR";

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ðŸŽµ Curation Complete for "${theme}"

              Theme: \`${theme}\`
              Status: ${success ? 'âœ… Success!' : 'âŒ Failed'}

              ${success
                ? `Claude Code has created a sound pack for the "${theme}" theme.

                  ðŸ“¦ Pack includes:
                  - pack.json with full metadata
                  - AIFF sounds for all events
                  - Ready for review and merge!

                  ðŸ”— Review here: https://github.com/${{ github.repository }}/pull/${prNumber}`
                : `Claude Code couldn't create the pack. Check the workflow logs for details.`}
            `});

  # Job: Simple fallback without Claude (manual curation)
  manual-curate:
    name: Manual Pack Creation
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'

    steps:
      - uses: actions/checkout@v4

      - name: Create placeholder pack
        run: |
          THEME="${{ github.event.inputs.theme }}"
          mkdir -p "packs/$THEME/sounds"

          cat > "packs/$THEME/pack.json" <<EOF
{
  "id": "$THEME",
  "name": "$(echo $THEME | sed 's/-/ /g' | awk '{for(i=1;i<=NF;i++)sub(/./,toupper(substr($i,1,1)),$i)}1')",
  "description": "Sound pack for theme: $THEME",
  "version": "1.0.0",
  "author": "manual",
  "events": {
    "stop": "stop.aiff",
    "permission_prompt": "permission_prompt.aiff",
    "idle_prompt": "idle_prompt.aiff",
    "subagent": "subagent.aiff"
  }
}
EOF

          echo "Created placeholder pack - add sounds manually"

      - name: Create PR
        uses: peter-evans/create-pull-request@v3
        with:
          token: ${{ secrets.GH_TOKEN }}
          title: "Add ${{ github.event.inputs.theme }} themed pack"
          body: "Placeholder pack - add sounds manually"

name: Theme Curation with Claude

on:
  # Manual trigger with theme input
  workflow_dispatch:
    inputs:
      theme:
        description: |
          Theme for the sound pack (e.g., retro, futuristic, nature, cinematic, lofi)
          Claude Code will search and curate sounds matching this theme.
        required: true
        type: string

  # Trigger via issue comment: "!curate retro"
  issue_comment:
    types: [created]

env:
  ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}

jobs:
  curate-pack:
    name: Curate "${{ steps.theme.outputs.value }}" Theme
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch' || (github.event_name == 'issue_comment' && starts_with(github.event.comment.body, '!curate'))

    steps:
      # 1. Checkout repo
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GH_TOKEN }}

      # 2. Parse theme from input or comment
      - name: Parse theme
        id: theme
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            THEME="${{ github.event.inputs.theme }}"
          else
            THEME=$(echo "${{ github.event.comment.body }}" | sed 's/!curate *//' | tr -d ' ')
          fi
          echo "value=$THEME" >> $GITHUB_OUTPUT
          echo "Theme: $THEME"

      # 3. Install dependencies
      - name: Set up dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y curl jq ffmpeg

      # 4. Claude Code creates the ENTIRE pack (sounds + pack.json)
      - name: Claude Code Curation
        id: claude
        uses: anthropics/claude-code-action@v1
        with:
          prompt: |
            You are a sound curator for ccbell notification plugin.

            YOUR TASK:
            Create a complete sound pack for theme: "${{ steps.theme.outputs.value }}"

            STEPS:
            1. Create directory: packs/${{ steps.theme.outputs.value }}/sounds/
            2. Search Pixabay API for sounds matching the theme for each event:
               - stop: completion, done, success sounds
               - permission_prompt: subtle notification, alert sounds
               - idle_prompt: waiting, timer, pause sounds
               - subagent: agent complete, task done sounds
            3. For each event, download the best matching sound to packs/${{ steps.theme.outputs.value }}/sounds/
            4. Convert each sound to AIFF format (ffmpeg -i input.aiff -f aiff output.aiff)
            5. Create packs/${{ steps.theme.outputs.value }}/pack.json with proper structure:

            ```json
            {
              "id": "${{ steps.theme.outputs.value }}",
              "name": "Theme Name (capitalized)",
              "description": "Description of the theme",
              "author": "claude-code",
              "version": "1.0.0",
              "events": {
                "stop": "stop.aiff",
                "permission_prompt": "permission_prompt.aiff",
                "idle_prompt": "idle_prompt.aiff",
                "subagent": "subagent.aiff"
              },
              "source": "pixabay",
              "license": "pixabay"
            }
            ```

            REQUIREMENTS:
            - Use Pixabay API: https://pixabay.com/api/?q={query}&category=sound-effects&per_page=5
            - Convert all sounds to AIFF (macOS compatible)
            - Use event-specific search queries
            - Clean up any MP3/WAV files after conversion

            OUTPUT:
            - Create the complete pack at: packs/${{ steps.theme.outputs.value }}/
            - List what you created: ls -la packs/${{ steps.theme.outputs.value }}/
            - Show the pack.json content
            - Tell the user the pack is ready for release

            Do NOT output a shell script. Do the work DIRECTLY in the filesystem.

      # 5. Verify pack was created
      - name: Verify pack
        id: verify
        run: |
          THEME="${{ steps.theme.outputs.value }}"
          echo "Verifying pack for theme: $THEME"

          if [ -d "packs/$THEME" ]; then
            echo "Pack directory exists"
            ls -la "packs/$THEME/"

            if [ -f "packs/$THEME/pack.json" ]; then
              echo "pack.json found:"
              cat "packs/$THEME/pack.json"
            else
              echo "ERROR: pack.json not found"
              exit 1
            fi

            sound_count=$(find "packs/$THEME/sounds" -name "*.aiff" | wc -l)
            echo "Sounds created: $sound_count"

            if [ "$sound_count" -lt 1 ]; then
              echo "ERROR: No sound files found"
              exit 1
            fi
          else
            echo "ERROR: Pack directory not created"
            exit 1
          fi

      # 6. Create release with sounds
      - name: Create Release
        id: release
        if: github.event_name != 'pull_request'
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ steps.theme.outputs.value }}-v1.0.0
          release_name: ${{ steps.theme.outputs.value }} v1.0.0
          body: |
            Sound pack for theme: **${{ steps.theme.outputs.value }}**

            Curated by Claude Code from Pixabay sounds.

            ## Events
            - stop
            - permission_prompt
            - idle_prompt
            - subagent

            ## Usage
            ```bash
            /ccbell:packs install ${{ steps.theme.outputs.value }}
            /ccbell:packs use ${{ steps.theme.outputs.value }}
            ```
          draft: false
          prerelease: false

      # 7. Create zip asset with pack.json + sounds
      - name: Prepare Release Asset
        id: asset
        if: github.event_name != 'pull_request'
        run: |
          THEME="${{ steps.theme.outputs.value }}"
          cd "packs/$THEME"

          # Create zip with pack.json + sounds/
          zip -r "$THEME.zip" pack.json sounds/

          echo "asset_path=$(pwd)/$THEME.zip" >> $GITHUB_OUTPUT
          echo "asset_name=$THEME.zip" >> $GITHUB_OUTPUT

      # 8. Upload release asset
      - name: Upload Release Asset
        id: upload
        if: github.event_name != 'pull_request'
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GHITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.release.outputs.upload_url }}
          asset_path: ${{ steps.asset.outputs.asset_path }}
          asset_name: ${{ steps.asset.outputs.asset_name }}
          asset_content_type: application/zip

      # 9. Commit pack.json to git (sounds stay local)
      - name: Commit pack.json
        run: |
          THEME="${{ steps.theme.outputs.value }}"
          cd ${{ github.workspace }}

          # Only commit pack.json, NOT sounds
          git add "packs/$THEME/pack.json"
          git status

          # Create commit
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git commit -m "Add $THEME themed sound pack

          - pack.json with full metadata
          - sounds available in release asset

          Generated by Claude Code"

      # 10. Push to remote
      - name: Push changes
        run: |
          git push

      # 11. Comment on result
      - name: Comment on result
        if: always()
        uses: actions/github-script@v6
        with:
          script: |
            const theme = "${{ steps.theme.outputs.value }}";
            const success = "${{ job.status }}" === "success";

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## üéµ Curation Complete for "${theme}"

              Theme: \`${theme}\`
              Status: ${success ? '‚úÖ Success!' : '‚ùå Failed'}

              ${success
                ? `Claude Code has created a sound pack for the "${theme}" theme.

                  üì¶ What was created:
                  - \`packs/${theme}/pack.json\` - committed to git
                  - Release asset - contains sounds/*.aiff

                  üîó Release: https://github.com/${{ github.repository }}/releases/tag/${theme}-v1.0.0

                  üí° Users can now install:
                  \`/ccbell:packs install ${theme}\``
                : `Claude Code couldn't create the pack. Check the workflow logs for details.`}
            `});
